<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>The Universal Data Structure - Elben Shira</title>
        <script>
          function getCookie(cname) {
              var name = cname + "=";
              var ca = document.cookie.split(';');
              for(var i=0; i<ca.length; i++) {
                  var c = ca[i];
                  while (c.charAt(0)==' ') c = c.substring(1);
                  if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
              }
              return "";
          }

          // If cookie set, assume font is cached, so load right away. May get
          // cache miss sometimes (esp w/ GitHub pages 10 min cache), but that's OK.
          if(getCookie("fonts-loaded") == "true") {
              document.documentElement.className += " fonts-loaded";
          }

          if(getCookie("code-fonts-loaded") == "true") {
              document.documentElement.className += " code-fonts-loaded";
          }

          window.addEventListener("load", function() {
            var elems = document.getElementsByClassName("view-comments");
            for (var i = 0; i < elems.length; ++i) {
              elems[i].onclick =
                function () {
                  var disqus = document.getElementById("disqus-comments");
                  if (disqus) {
                    disqus.classList.remove("hide");
                    this.classList.add("hide");
                  }
                }
            }
          });
        </script>

        <link rel="stylesheet" type="text/css" href="/stylesheets/default.css" />
    </head>
    <body>
      <div id="structure">
        <div id="header">
          <h1 itemprop="name"><a href="/">Elben Shira</a></h1>
          <span id="navigation">
            <a href="/blog/">Blog</a>
            <a href="/projects/">Projects</a>
          </span>
          <hr>
        </div>

        <div id="content">
          <article class="post-content">
  <header class="post-header">
    <h1 class="post-title">The Universal Data Structure</h1>

    <div class="post-metadata">
      <div class="date">
        June 26, 2015
         / <a href="/blog/tags/recommended/">recommended</a>  / <a href="/blog/tags/bad-theory/">bad-theory</a> 
      </div>
    </div>
  </header>

  
<p>Whether you write compilers, web services or Django admin panels, you probably use <strong>hash maps</strong> more than all other data structures combined. In fact, you may not remember the last time you used anything else. This is not a coincidence: <strong>any conceivable data structure can be implemented with a hash map; therefore, there is no need to use any other data structure</strong>.</p>
<p>Specifically, the only hash you need is this one:</p>
<p><code>UniversalHash = Hash[String|Int, UniversalHash|String]</code></p>
<p>(If you’re not one of those Haskell or Scalaz guys, the complicated expression above tells us that a “universal hash” is a hash where the keys are either strings and integers, and the values are either universal hashes or strings.)</p>
<p>The universal hash obsoletes not just all other hash structures, but all other data structures. In this article, I’ll show you why this is a good thing, and why you’ll want to use the universal hash everywhere.</p>
<h2 id="common-patterns">Common patterns</h2>
<p>We all admit that a hash is the <em>lingua franca</em> of programming. What is a User, after all, but just a hash:</p>
<pre><code>{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;email&quot;: &quot;alice@example.com&quot;
}</code></pre>
<p>And we can’t forget our favorite JavaScript interview question of all time: If you only had twenty-four hours to implement arrays in JavaScript, how would you do it? Answer: with a hash!</p>
<pre><code>{
  0: &quot;First&quot;,
  1: &quot;Second&quot;,
  2: &quot;Third&quot;,
  …
}</code></pre>
<p>And then on the third day, a collection of users:</p>
<pre><code>{
  0: { &quot;name&quot;: …, &quot;email&quot;: …},
  1: { &quot;name&quot;: …, &quot;email&quot;: …},
}</code></pre>
<p>Or, to specify relationships of managers to drones:</p>
<pre><code>{
  &quot;id&quot;: &quot;1&quot;,
  &quot;name&quot;: &quot;Bob&quot;,
  &quot;is_manager&quot;: &quot;true&quot;
}</code></pre>
<pre><code>{
  &quot;id&quot;: &quot;2&quot;,
  &quot;name&quot;: &quot;Adrian&quot;,
  &quot;is_manager&quot;: &quot;false&quot;,
  &quot;manager_id&quot;: &quot;1&quot;
}</code></pre>
<p>In fact, this pattern is so common that this year vulture capitalists have poured over $30 billion on JSON-backed database technologies. That is, hash-backed techonologies.</p>
<h2 id="why-this-is-a-good-thing">Why this is a good thing</h2>
<p>Given the abysmal state of of today’s software engineering, I believe that a full embrace of the universal hash will result in better, simpler programs.</p>
<p>First of all, a hash is simple to understand. JSON, for example, is the most-famous of all hash-based DSLs. And anyone can read JSON—even your product manager!</p>
<p>Second, hashes are fast. Hashes are always O(1) reads, inserts and writes. Why try to understand logarithms when “1” is not only much <em>easier</em> but also <em>faster</em>. (Note: there’s something about amortized complexity, but that’s a rare anomaly over billions of hits).</p>
<p>Third, every modern language (e.g. Ruby, CoffeeScript) comes with a good hash implementation and an easy-to-type syntax. There ain’t nothing easier than typing <code>{}</code> to initialize a database. I mean, show me a language with easy-to-type, first-class support for, God-forbid, finger trees. Can you even do that in ASCII? Thankfully, progressive language designers learned something post-Java: save curly braces for hashes.</p>
<p>Finally, hashes are malleable. Just as languages that support macros (e.g. LISP, Scalaz) can define control structures that macro-less languages can only dream about, using hashes allow a malleability that other data structures just don’t have. If you choose a tree to represent a file system, for example, you’re stuck with a tree-looking thing. An array is even less flexible—you have to use integers as your keys. So use hashes to give you that wiggle room you need. Because it’s not <em>if</em> your schema changes, but <em>when</em>. And <em>when</em> my schema changes, I’d rather be transforming a hash than a tree. (Plus, tree transformations are slow since those algorithms are recursive).</p>
<h2 id="academic-stuff">Academic stuff</h2>
<p>OK, you’re all-in on the idea that a hash is the most useful data structure man or woman will ever invent (and let’s face it, you may have read <a href="https://en.wikipedia.org/wiki/Finger_tree">en.wikipedia.org/wiki/Finger_tree</a> five times but you’ll never used it). But how can you <em>know</em> for certain that a hash is all you’ll ever need? For this, we need a proof.</p>
<p>I usually try to avoid the rigorous thinking type of articles because why should we water down good analogies with rigor? Why spend hours working through difficult exercises when I can just show you a comic of a caterpillar eating a spider to describe some abstract concept? Let’s all admit that most of the time, the caterpillar analogies are sufficient, and we render LaTeX only to play Mathematician.</p>
<p>But I’m going to risk some academic stuff because I think it’s important enough to delve into the theory. And for once, its not too much work. It’s a proof for the common programmer, not just those ivy tower theorists.</p>
<p>The proof is so easy it’s a snore.</p>
<p><strong>Theorem</strong>. Any conceivable data structure can be implemented with a hash of type <code>UniversalHash = Hash[String|Int, UniversalHash|String]</code>.</p>
<p><strong>Proof</strong>.</p>
<ol type="1">
<li>Every conceivable data structure must exist in main memory.</li>
<li>Main memory is a mapping of addresses to values, where addresses are integers, and values are bytes (i.e. strings). This is equivalent to the type <code>Hash[Int, String]</code>.</li>
<li>Any <code>Hash[Int, String]</code> is a sub-type of <code>Hash[String|Int, UniversalHash|String]</code>.</li>
<li>Therefore, every conceivable data structure can be implemented using only <code>Hash[String|Int, UniversalHash|String]</code>.</li>
<li>QED.</li>
</ol>
<p>You may ask, why use <code>UniversalHash</code> when you can just use <code>Hash[Int, String]</code>, which has the equivalent flexibility of main memory? The answer is simple: simplification. If we only had <code>Hash[Int, String]</code>, then our programs would have to mimic the low-level operations of languages like ASM, C and Rust. We would have to learn about stuff like bit shifting, XOR and maybe even virtual memory (since Moore’s Law is failing us). By <em>complexing</em> to <code>UniversalHash</code>, we are actually <em>simplexing</em>. This is one of those brilliant Hickey moments; something complex was made simple via a proper dose of complex.</p>
<p>OK, let’s QED this part and move on.</p>
<h2 id="implementing-other-data-structures-on-the-universalhash">Implementing other data structures on the UniversalHash</h2>
<p>The theorem above proved that every data structure is just a hash. In this section, I’ll show some examples of how different data structures can be implemented on top of a universal hash.</p>
<p>(By the way, a <em>theorem</em> is academic lingo for a truth backed by a <em>proof</em>, which is academic lingo for an irrefutable argument using our God-given logic, other proven theorems and a couple of God-given <em>axioms</em>, which is academic lingo for a <em>truth</em> we accept purely by our God-given logic, like: if something is not true then it is false, something cannot exist in an empty set, something logical is logical.)</p>
<h3 id="array">Array</h3>
<p>As seen before, an array is just a hash where the keys are indices to the array.</p>
<p>Most famous is JavaScript’s implementation of arrays, which erases a litany of bugs by returning <code>undefined</code> if the provided index is out of bounds. Universal values like <code>undefined</code> and <code>null</code> are useful values to return if you want to indicate system failure, out of memory error, user error, invalid memory location, timeout, nothing, something, anything.</p>
<h3 id="linked-list">Linked list</h3>
<p>Linked lists suffer an O(n) look up. I don’t know why you would ever use this over an array (or a hash), but you can implement it via a <code>UniversalHash</code>. Here’s a linked list of two elements:</p>
<pre><code>{
  &quot;head&quot;: &quot;objectid1&quot;,
  &quot;objectid1&quot;: {
    &quot;value&quot;: …,
    &quot;next&quot;: &quot;objectid2&quot;
  },
  &quot;objectid2&quot;: {
    &quot;value&quot;: …,
    &quot;next&quot;: null
  }
}</code></pre>
<h3 id="tree">Tree</h3>
<p>A tree is a node, where a node is just a value paired with an array of nodes.</p>
<pre><code>{
  &quot;value&quot;: …,
  &quot;children&quot;: {
    0: {
      &quot;value&quot;: …,
      &quot;children&quot;: { … }
    },
    1: …,
  }
}</code></pre>
<h3 id="postgres">Postgres</h3>
<p>I am so sick and tired of this question: “why don’t you just use Postgres?” The answer is the same chorus: because everything ends up being a hash anyways!</p>
<p>Remember when everyone used tables to lay out their HTML? Well, that proved to be a horrible way to do things, because tables are inherently inflexible. It’s a strictly <em>geometric</em> constraint. Now we all use <code>div</code>s and CSS, because we get a much-more flexible CSS engine to define our layout. Postgres and her SQL friends are all table based, just like the <code>&lt;table&gt;</code> of 1999. Don’t be 1999.</p>
<h3 id="json">JSON</h3>
<p>JSON support things like booleans, floating points, integers, etc. How can we support these types if we only have a <code>UniversalHash = Hash[String|Int, UniversalHash|String]</code>? There’s a simple solution that the bookmarking company <a href="https://delicious.com/">del.icio.us</a> heralded: just tag stuff. For example, say our JSON looks like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Bob&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="dt">&quot;is_manager&quot;</span><span class="fu">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>We can represent this like this:</p>
<pre><code>{
  &quot;id&quot;:         {&quot;value&quot;: &quot;1&quot;,    &quot;tag&quot;: &quot;integer&quot;},
  &quot;name&quot;:       {&quot;value&quot;: &quot;Bob&quot;,  &quot;tag&quot;: &quot;string&quot;},
  &quot;is_manager&quot;: {&quot;value&quot;: &quot;true&quot;, &quot;tag&quot;: &quot;boolean&quot;}
}</code></pre>
<p>Now, our program can just read the <code>tag</code> and know what to do with the string value. In fact, this is what compiler writers have to do, since everything is just a bunch of bytes at the end of the day.</p>
<p>And to blow your minds even more, note that we’re implementing hashes with hashes.</p>
<p>(Some of you may question how we got the first implementation of a hash to begin with. When you type <code>{}</code>, the compiler surely puts that in a hash. But where did the <em>compiler’s</em> hash come from? This is where <em>mathematical induction</em> comes in. It’s a big math word that basically means that if you can prove that the bottom rung of your ladder exists, and you can get from rung <em>n</em> to rung <em>(n-1)</em>, then you’ll eventually get off the ladder. Well, we know main memory is really just a <code>Hash[Int, String]</code>. And since we can implement hashes with hashes, this means that a hash can be implemented.)</p>
<h2 id="practical-implications">Practical implications</h2>
<p>Unlike most academic work that has little to no practical implications, I think blindly following the stuff here will prove to be incalculably beneficial for you.</p>
<p>When a co-worker or interviewee stuffs some data into a hash even though it looks suspiciously like a tree, remind yourself that it’s OK—everything is just a hash. Plus, hashes are faster.</p>
<p>And when you’re picking database technology, I recommend that you choose databases that are flexible by nature. That is, databases that use the <em>hash</em> as the standard unit of storage, instead of rows or what-not.</p>
<p>I hope you’re convinced. A hash is simple. A hash is fast. A hash is all you need.</p>
</article>

<div class="post-content-end">
  <hr>

  <div class="view-comments">
    <a>View comments</a>
  </div>

  <div id="disqus-comments" class="hide">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'elbenshira';
      var disqus_category_id = '2658740'; // "Blog" category.

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
    </script>
    <noscript>Enable JavaScript to view Disqus comments.</noscript>
  </div>

</div>

        </div>
      </div>

      <script>
        /* Font Face Observer v2.0.13 - © Bram Stein. License: BSD-3-Clause https://raw.githubusercontent.com/bramstein/fontfaceobserver */
        (function(){'use strict';var f,g=[];function l(a){g.push(a);1==g.length&&f()}function m(){for(;g.length;)g[0](),g.shift()}f=function(){setTimeout(m)};function n(a){this.a=p;this.b=void 0;this.f=[];var b=this;try{a(function(a){q(b,a)},function(a){r(b,a)})}catch(c){r(b,c)}}var p=2;function t(a){return new n(function(b,c){c(a)})}function u(a){return new n(function(b){b(a)})}function q(a,b){if(a.a==p){if(b==a)throw new TypeError;var c=!1;try{var d=b&&b.then;if(null!=b&&"object"==typeof b&&"function"==typeof d){d.call(b,function(b){c||q(a,b);c=!0},function(b){c||r(a,b);c=!0});return}}catch(e){c||r(a,e);return}a.a=0;a.b=b;v(a)}}
function r(a,b){if(a.a==p){if(b==a)throw new TypeError;a.a=1;a.b=b;v(a)}}function v(a){l(function(){if(a.a!=p)for(;a.f.length;){var b=a.f.shift(),c=b[0],d=b[1],e=b[2],b=b[3];try{0==a.a?"function"==typeof c?e(c.call(void 0,a.b)):e(a.b):1==a.a&&("function"==typeof d?e(d.call(void 0,a.b)):b(a.b))}catch(h){b(h)}}})}n.prototype.g=function(a){return this.c(void 0,a)};n.prototype.c=function(a,b){var c=this;return new n(function(d,e){c.f.push([a,b,d,e]);v(c)})};
function w(a){return new n(function(b,c){function d(c){return function(d){h[c]=d;e+=1;e==a.length&&b(h)}}var e=0,h=[];0==a.length&&b(h);for(var k=0;k<a.length;k+=1)u(a[k]).c(d(k),c)})}function x(a){return new n(function(b,c){for(var d=0;d<a.length;d+=1)u(a[d]).c(b,c)})};window.Promise||(window.Promise=n,window.Promise.resolve=u,window.Promise.reject=t,window.Promise.race=x,window.Promise.all=w,window.Promise.prototype.then=n.prototype.c,window.Promise.prototype["catch"]=n.prototype.g);}());

             (function(){function l(a,b){document.addEventListener?a.addEventListener("scroll",b,!1):a.attachEvent("scroll",b)}function m(a){document.body?a():document.addEventListener?document.addEventListener("DOMContentLoaded",function c(){document.removeEventListener("DOMContentLoaded",c);a()}):document.attachEvent("onreadystatechange",function k(){if("interactive"==document.readyState||"complete"==document.readyState)document.detachEvent("onreadystatechange",k),a()})};function r(a){this.a=document.createElement("div");this.a.setAttribute("aria-hidden","true");this.a.appendChild(document.createTextNode(a));this.b=document.createElement("span");this.c=document.createElement("span");this.h=document.createElement("span");this.f=document.createElement("span");this.g=-1;this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";
             this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;";this.b.appendChild(this.h);this.c.appendChild(this.f);this.a.appendChild(this.b);this.a.appendChild(this.c)}
             function t(a,b){a.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+b+";"}function y(a){var b=a.a.offsetWidth,c=b+100;a.f.style.width=c+"px";a.c.scrollLeft=c;a.b.scrollLeft=a.b.scrollWidth+100;return a.g!==b?(a.g=b,!0):!1}function z(a,b){function c(){var a=k;y(a)&&a.a.parentNode&&b(a.g)}var k=a;l(a.b,c);l(a.c,c);y(a)};function A(a,b){var c=b||{};this.family=a;this.style=c.style||"normal";this.weight=c.weight||"normal";this.stretch=c.stretch||"normal"}var B=null,C=null,E=null,F=null;function G(){if(null===C)if(J()&&/Apple/.test(window.navigator.vendor)){var a=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent);C=!!a&&603>parseInt(a[1],10)}else C=!1;return C}function J(){null===F&&(F=!!document.fonts);return F}
function K(){if(null===E){var a=document.createElement("div");try{a.style.font="condensed 100px sans-serif"}catch(b){}E=""!==a.style.font}return E}function L(a,b){return[a.style,a.weight,K()?a.stretch:"","100px",b].join(" ")}
A.prototype.load=function(a,b){var c=this,k=a||"BESbswy",q=0,D=b||3E3,H=(new Date).getTime();return new Promise(function(a,b){if(J()&&!G()){var M=new Promise(function(a,b){function e(){(new Date).getTime()-H>=D?b():document.fonts.load(L(c,'"'+c.family+'"'),k).then(function(c){1<=c.length?a():setTimeout(e,25)},function(){b()})}e()}),N=new Promise(function(a,c){q=setTimeout(c,D)});Promise.race([N,M]).then(function(){clearTimeout(q);a(c)},function(){b(c)})}else m(function(){function u(){var b;if(b=-1!=
  f&&-1!=g||-1!=f&&-1!=h||-1!=g&&-1!=h)(b=f!=g&&f!=h&&g!=h)||(null===B&&(b=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),B=!!b&&(536>parseInt(b[1],10)||536===parseInt(b[1],10)&&11>=parseInt(b[2],10))),b=B&&(f==v&&g==v&&h==v||f==w&&g==w&&h==w||f==x&&g==x&&h==x)),b=!b;b&&(d.parentNode&&d.parentNode.removeChild(d),clearTimeout(q),a(c))}function I(){if((new Date).getTime()-H>=D)d.parentNode&&d.parentNode.removeChild(d),b(c);else{var a=document.hidden;if(!0===a||void 0===a)f=e.a.offsetWidth,
  g=n.a.offsetWidth,h=p.a.offsetWidth,u();q=setTimeout(I,50)}}var e=new r(k),n=new r(k),p=new r(k),f=-1,g=-1,h=-1,v=-1,w=-1,x=-1,d=document.createElement("div");d.dir="ltr";t(e,L(c,"sans-serif"));t(n,L(c,"serif"));t(p,L(c,"monospace"));d.appendChild(e.a);d.appendChild(n.a);d.appendChild(p.a);document.body.appendChild(d);v=e.a.offsetWidth;w=n.a.offsetWidth;x=p.a.offsetWidth;I();z(e,function(a){f=a;u()});t(e,L(c,'"'+c.family+'",sans-serif'));z(n,function(a){g=a;u()});t(n,L(c,'"'+c.family+'",serif'));
z(p,function(a){h=a;u()});t(p,L(c,'"'+c.family+'",monospace'))})})};"object"===typeof module?module.exports=A:(window.FontFaceObserver=A,window.FontFaceObserver.prototype.load=A.prototype.load);}());

(function(w) {
  if(w.document.documentElement.className.indexOf("fonts-loaded") <= 0) {
    // Fonts not yet loaded. Wait for them to load, then append the class that
    // will set the loaded font.

    var charterNN = new w.FontFaceObserver("Charter", { weight: "normal", style: "normal" });
    var charterNI = new w.FontFaceObserver("Charter", { weight: "normal", style: "italic" });
    var charterBN = new w.FontFaceObserver("Charter", { weight: "bold", style: "normal" });
    var charterBI = new w.FontFaceObserver("Charter", { weight: "bold", style: "italic" });
    w.Promise.all([
      charterNN.load(null, 3000),
      charterNI.load(null, 3000),
      charterBN.load(null, 3000),
      charterBI.load(null, 3000)
    ]).then(function() {
      w.document.documentElement.className += " fonts-loaded";
      document.cookie="fonts-loaded=true";
    });
  }

  if(w.document.documentElement.className.indexOf("code-fonts-loaded") <= 0) {
    var sourceCodePro400N = new w.FontFaceObserver("Source Code Pro", { weight: "400", style: "normal" });
    var sourceCodePro600N = new w.FontFaceObserver("Source Code Pro", { weight: "600", style: "normal" });
    w.Promise.all([
      sourceCodePro400N.load(null, 3000),
      sourceCodePro600N.load(null, 3000)
    ]).then(function() {
      w.document.documentElement.className += " code-fonts-loaded";
      document.cookie="code-fonts-loaded=true";
    });
  }
}(this));
      </script>
    </body>
</html>
